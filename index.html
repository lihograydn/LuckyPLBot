    <script>
        // ================== CONFIG ==================
        // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –°–°–´–õ–ö–£ NGROK (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://a1b2-c3d4.ngrok-free.app)
        const API_URL = 'https://0c34-188-163-14-188.ngrok-free.app'; 

        // ================== TELEGRAM WEB APP INTEGRATION ==================
        const tg = window.Telegram?.WebApp;

        // ================== CORE DATA & STATE ==================
        const DEFAULT_DATA = {
            nickname: '–ò–≥—Ä–æ–∫', balance: 1000, wins: 0, losses: 0,
            totalWon: 0, totalLost: 0, hourlyBonusTime: 0, dailyBonusTime: 0
        };
        let gameData = { ...DEFAULT_DATA };
        let allPlayers = [];
        let myID = 'local_user';
        let adminClickCounter = 0;
        let adminClickTimer = null;

        // ================== BACKEND SYNC ==================
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function fetchBalance() {
            if (!API_URL) {
                console.warn("API_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –†–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω.");
                return;
            }
            try {
                const response = await fetch(`${API_URL}/getBalance?user_id=${myID}`);
                const result = await response.json();
                
                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    gameData.balance = result.balance;
                    gameData.nickname = result.nickname;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫–Ω–µ–π–º –≤ –∏–Ω–ø—É—Ç
                    const nicknameInput = document.getElementById('nickname-input');
                    if (nicknameInput) nicknameInput.value = gameData.nickname;
                    
                    updateUI();
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function syncBalance(change, nickname = null) {
            if (!API_URL) return;

            try {
                const response = await fetch(`${API_URL}/updateBalance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: myID,
                        change: change,
                        nickname: nickname || gameData.nickname
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
                    gameData.balance = result.new_balance;
                    updateUI();
                    saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∫—ç—à
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
            }
        }

        // ================== DOM ELEMENTS ==================
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section');
        
        // Profile & Stats
        const nicknameInput = document.getElementById('nickname-input');
        const displayNickname = document.getElementById('display-nickname');
        const saveNicknameBtn = document.getElementById('save-nickname');
        const profileBalance = document.getElementById('profile-balance');
        const headerBalance = document.getElementById('header-balance');
        const statsWins = document.getElementById('stats-wins');
        const statsLosses = document.getElementById('stats-losses');
        const statsWon = document.getElementById('stats-won');
        const statsLost = document.getElementById('stats-lost');
        const statsProfit = document.getElementById('stats-profit');

        // Admin Elements
        const balanceContainer = document.getElementById('balance-container');
        const adminPanel = document.getElementById('adminPanel');
        const adminOverlay = document.getElementById('adminOverlay');
        const closeAdminBtn = document.getElementById('closeAdmin');
        const adminAmountInput = document.getElementById('admin-amount');
        const adminAddMoneyBtn = document.getElementById('admin-add-money');
        const adminResetBonusesBtn = document.getElementById('admin-reset-bonuses');
        const adminResetStatsBtn = document.getElementById('admin-reset-stats');

        // Bonus
        const hourlyBonusBtn = document.getElementById('hourly-bonus');
        const dailyBonusBtn = document.getElementById('daily-bonus');
        const hourlyTimer = document.getElementById('hourly-timer');
        const dailyTimer = document.getElementById('daily-timer');

        // ================== UTILS ==================
        
        function saveData() { 
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ç–∞–π–º–µ—Ä—ã, –±–∞–ª–∞–Ω—Å –±–µ—Ä–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            let saveState = { ...gameData };
            localStorage.setItem('mcoin_game_' + myID, JSON.stringify(saveState)); 
        }
        
        function loadData() {
            // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                myID = tg.initDataUnsafe.user.id.toString();
                console.log("–ó–∞–ø—É—â–µ–Ω–æ –≤ Telegram, ID:", myID);
                tg.expand(); 
            } else {
                console.log("–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º");
                let storedID = localStorage.getItem('mcoin_local_id');
                if (storedID) myID = storedID;
                else {
                    myID = 'player_' + Math.floor(Math.random() * 100000);
                    localStorage.setItem('mcoin_local_id', myID);
                }
            }

            const saved = localStorage.getItem('mcoin_game_' + myID);
            if (saved) {
                const parsed = JSON.parse(saved);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—ã, –Ω–æ –±–∞–ª–∞–Ω—Å –ø–æ–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (–ø–æ–ª—É—á–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞)
                gameData.wins = parsed.wins || 0;
                gameData.losses = parsed.losses || 0;
                gameData.totalWon = parsed.totalWon || 0;
                gameData.totalLost = parsed.totalLost || 0;
                gameData.hourlyBonusTime = parsed.hourlyBonusTime || 0;
                gameData.dailyBonusTime = parsed.dailyBonusTime || 0;
                gameData.nickname = parsed.nickname || '–ò–≥—Ä–æ–∫';
            }
            
            const savedPlayers = localStorage.getItem('mcoin_all_players');
            if (savedPlayers) allPlayers = JSON.parse(savedPlayers);
        }

        function updateUI() {
            displayNickname.textContent = gameData.nickname;
            nicknameInput.value = gameData.nickname;
            profileBalance.textContent = gameData.balance.toFixed(2);
            headerBalance.textContent = gameData.balance.toFixed(2);
            statsWins.textContent = gameData.wins;
            statsLosses.textContent = gameData.losses;
            
            const profit = gameData.totalWon - gameData.totalLost;
            statsWon.textContent = '+' + gameData.totalWon.toFixed(2);
            statsLost.textContent = '-' + gameData.totalLost.toFixed(2);
            statsProfit.textContent = (profit >= 0 ? '+' : '') + profit.toFixed(2);
            statsProfit.style.color = profit >= 0 ? '#22c55e' : '#ef4444';
            
            updatePlayerInLeaderboard();
        }

        function updatePlayerInLeaderboard() {
            const idx = allPlayers.findIndex(p => p.id === myID);
            const playerData = { id: myID, name: gameData.nickname, balance: gameData.balance };
            if (idx >= 0) allPlayers[idx] = playerData;
            else allPlayers.push(playerData);
            localStorage.setItem('mcoin_all_players', JSON.stringify(allPlayers));
        }

        function switchSection(sectionId) {
            navItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            sections.forEach(section => section.classList.toggle('active', section.id === sectionId));
            if (sectionId === 'top') renderLeaderboard();
        }

        function formatTime(s) {
            return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }

        function showNotification(msg, type) {
            const colors = { success: 'bg-[#22c55e]', error: 'bg-[#ef4444]', info: 'bg-[#f0b429]' };
            const n = document.createElement('div');
            n.className = `fixed top-20 left-1/2 -translate-x-1/2 ${colors[type]} text-black px-6 py-3 rounded-xl font-bold z-50`;
            n.textContent = msg;
            n.style.animation = 'fadeIn 0.3s ease';
            document.body.appendChild(n);
            setTimeout(() => { n.style.opacity = '0'; n.style.transition = 'opacity 0.3s'; setTimeout(() => n.remove(), 300); }, 2000);
        }

        // –ò–ó–ú–ï–ù–ï–ù–û: –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function genericEndGame(won, amount) {
            const change = won ? amount : -amount; // –ï—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏, —Å—É–º–º–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è (–¥–ª—è –ª–æ–≥–æ–≤)
            
            if (won) {
                gameData.wins++;
                gameData.totalWon += amount;
                showNotification(`+${amount.toFixed(2)} mCoin`, 'success');
                syncBalance(amount); // –ü–ª—é—Å—É–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            } else {
                gameData.losses++;
                gameData.totalLost += amount;
                showNotification(`-${amount.toFixed(2)} mCoin`, 'error');
                // –ú–∏–Ω—É—Å—É–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–æ –±–∞–ª–∞–Ω—Å —É–∂–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
                // –ú—ã —É–∂–µ —Å–ø–∏—Å–∞–ª–∏ —Å—Ç–∞–≤–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–∞
                fetchBalance(); 
            }
            
            saveData();
        }

        // –ò–ó–ú–ï–ù–ï–ù–û: –ê–¥–º–∏–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ —à–ª–µ—Ç –∑–∞–ø—Ä–æ—Å
        function adminAddMoney(amount) {
            syncBalance(amount);
        }
        
        // ================== ADMIN LOGIC ==================
        function toggleAdminPanel(show) {
            if (show) { adminPanel.classList.add('active'); adminOverlay.classList.add('active'); }
            else { adminPanel.classList.remove('active'); adminOverlay.classList.remove('active'); }
        }
        balanceContainer.addEventListener('click', () => {
            adminClickCounter++;
            if (adminClickTimer) clearTimeout(adminClickTimer);
            if (adminClickCounter >= 5) { toggleAdminPanel(true); adminClickCounter = 0; }
            adminClickTimer = setTimeout(() => { adminClickCounter = 0; }, 1000);
        });
        closeAdminBtn.addEventListener('click', () => toggleAdminPanel(false));
        adminOverlay.addEventListener('click', () => toggleAdminPanel(false));
        adminAddMoneyBtn.addEventListener('click', () => {
            const amount = parseFloat(adminAmountInput.value);
            if (!isNaN(amount) && amount !== 0) {
                adminAddMoney(amount);
                showNotification(`–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${amount > 0 ? '+' : ''}${amount}`, 'success');
            }
        });
        adminResetBonusesBtn.addEventListener('click', () => {
            gameData.hourlyBonusTime = 0; gameData.dailyBonusTime = 0;
            saveData(); updateBonusTimers(); showNotification('–ë–æ–Ω—É—Å—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
        });
        adminResetStatsBtn.addEventListener('click', () => {
            if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                gameData.wins = 0; gameData.losses = 0; gameData.totalWon = 0; gameData.totalLost = 0;
                saveData(); updateUI(); showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'info');
            }
        });

        // ================== BONUSES ==================
        function updateBonusTimers() {
            const now = Math.floor(Date.now() / 1000);
            const hRem = Math.max(0, gameData.hourlyBonusTime - now);
            hourlyTimer.textContent = formatTime(hRem);
            hourlyBonusBtn.disabled = hRem > 0;
            hourlyBonusBtn.textContent = hRem > 0 ? '–ñ–¥–∏—Ç–µ' : '–ó–∞–±—Ä–∞—Ç—å';

            const dRem = Math.max(0, gameData.dailyBonusTime - now);
            dailyTimer.textContent = formatTime(dRem);
            dailyBonusBtn.disabled = dRem > 0;
            dailyBonusBtn.textContent = dRem > 0 ? '–ñ–¥–∏—Ç–µ' : '–ó–∞–±—Ä–∞—Ç—å';
        }

        function claimHourly() {
            const now = Math.floor(Date.now() / 1000);
            if (now >= gameData.hourlyBonusTime) {
                syncBalance(50);
                gameData.hourlyBonusTime = now + 3600;
                saveData(); updateBonusTimers();
                showNotification('+50 mCoin', 'success');
            }
        }

        function claimDaily() {
            const now = Math.floor(Date.now() / 1000);
            if (now >= gameData.dailyBonusTime) {
                syncBalance(500);
                gameData.dailyBonusTime = now + 86400;
                saveData(); updateBonusTimers();
                showNotification('+500 mCoin', 'success');
            }
        }

        // ================== LEADERBOARD ==================
        function renderLeaderboard() {
            const el = document.getElementById('leaderboard');
            if (!allPlayers.length) { el.innerHTML = `<div class="empty-state"><p>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</p></div>`; return; }
            const sorted = [...allPlayers].sort((a,b) => b.balance - a.balance);
            el.innerHTML = sorted.map((p, i) => {
                const rk = i===0 ? 'rank-1' : i===1 ? 'rank-2' : i===2 ? 'rank-3' : 'rank-other';
                return `<div class="leaderboard-item ${p.id===myID?'current-player':''} ${i===0?'top-1':''}">
                    <div class="rank ${rk}">${i+1}</div>
                    <div class="flex-1 font-medium">${p.name}${p.id===myID?' (–í—ã)': ''}</div>
                    <div class="flex items-center gap-1"><svg class="w-4 h-4 text-[#f0b429]" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg><span class="mono font-bold">${p.balance.toFixed(2)}</span></div>
                </div>`;
            }).join('');
        }

        // ================== MINES GAME ==================
        const MULTIPLIERS = {
            1: [1.01,1.05,1.10,1.15,1.21,1.27,1.34,1.42,1.51,1.61,1.73,1.86,2.02,2.20,2.42,2.69,3.03,3.46,4.04,4.85,6.06,8.08,12.12,24.25],
            2: [1.05,1.15,1.26,1.38,1.53,1.70,1.90,2.14,2.42,2.77,3.19,3.73,4.40,5.29,6.46,8.08,10.39,13.85,19.40,29.10,48.50,97.00,291.00],
            3: [1.10,1.26,1.45,1.67,1.95,2.28,2.70,3.23,3.92,4.82,6.03,7.71,10.09,13.56,18.79,27.09,40.94,65.50,114.62,225.58,563.96,2255.83],
            4: [1.15,1.38,1.67,2.05,2.53,3.16,4.00,5.15,6.78,9.14,12.71,18.28,27.42,43.43,73.83,137.55,289.58,723.95,2292.52,11462.58,114625.83],
            5: [1.21,1.53,1.96,2.53,3.32,4.43,6.01,8.33,11.80,17.15,25.73,39.92,64.22,108.38,192.67,368.53,773.91,1934.78,6771.74,50788.04]
        };
        
        let minesState = { isPlaying: false, bet: 0, minesCount: 5, mines: [], revealed: 0, mult: 1, gameOver: false };
        const mineGrid = document.getElementById('mine-grid');
        const minesBetInput = document.getElementById('mines-bet');
        const minesCountInput = document.getElementById('mines-count');
        const minesMultDisplay = document.getElementById('mines-mult');
        const minesStatus = document.getElementById('mines-status');
        const minesStartBtn = document.getElementById('mines-start');
        const minesCashoutBtn = document.getElementById('mines-cashout');

        function createMineGrid() {
            mineGrid.innerHTML = '';
            for(let i=0; i<25; i++) {
                const c = document.createElement('div');
                c.className = 'mine-cell';
                c.dataset.idx = i;
                mineGrid.appendChild(c);
            }
        }
        
        function startMines() {
            const bet = parseFloat(minesBetInput.value);
            const cnt = parseInt(minesCountInput.value);
            if(isNaN(bet) || bet < 1 || bet > gameData.balance) return showNotification('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞', 'error');
            if(isNaN(cnt) || cnt < 1 || cnt > 24) return showNotification('–ú–∏–Ω—ã: 1-24', 'error');
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            gameData.balance -= bet; // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI();
            syncBalance(-bet); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ
            
            minesState = { isPlaying: true, bet, minesCount: cnt, mines: [], revealed: 0, mult: 1, gameOver: false };
            const pos = [];
            while(pos.length < cnt) { const p = Math.floor(Math.random()*25); if(!pos.includes(p)) pos.push(p); }
            minesState.mines = pos;

            createMineGrid();
            minesMultDisplay.textContent = '1.00x';
            minesStatus.innerHTML = '<p class="text-[#f0b429]">–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</p>';
            minesStartBtn.disabled = true;
            minesCashoutBtn.disabled = true;
            minesBetInput.disabled = true;
            minesCountInput.disabled = true;

            document.querySelectorAll('.mine-cell').forEach(c => c.addEventListener('click', handleMineClick));
        }

        function handleMineClick(e) {
            if(!minesState.isPlaying || minesState.gameOver) return;
            const cell = e.target.closest('.mine-cell');
            const idx = parseInt(cell.dataset.idx);
            if(cell.classList.contains('revealed')) return;
            cell.classList.add('revealed');

            if(minesState.mines.includes(idx)) {
                cell.classList.add('mine');
                cell.innerHTML = `<svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#ef4444"/><circle cx="12" cy="12" r="4" fill="#0a0a0f"/></svg>`;
                endMines(false);
            } else {
                cell.classList.add('gem');
                cell.innerHTML = `<svg class="w-8 h-8 text-[#22c55e]" fill="currentColor" viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg>`;
                minesState.revealed++;
                const arr = MULTIPLIERS[minesState.minesCount] || [1];
                minesState.mult = arr[minesState.revealed-1] || 1;
                minesMultDisplay.textContent = minesState.mult.toFixed(2) + 'x';
                minesCashoutBtn.disabled = false;
                
                if(minesState.revealed >= 25 - minesState.minesCount) endMines(true);
            }
        }

        function endMines(won) {
            minesState.gameOver = true;
            minesState.isPlaying = false;
            document.querySelectorAll('.mine-cell').forEach((c, i) => {
                c.classList.add('game-over');
                if(minesState.mines.includes(i) && !c.classList.contains('mine')) {
                    c.classList.add('mine');
                    c.innerHTML = `<svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#ef4444"/><circle cx="12" cy="12" r="4" fill="#0a0a0f"/></svg>`;
                }
            });

            if(won) {
                const win = minesState.bet * minesState.mult;
                genericEndGame(true, win);
                minesStatus.innerHTML = `<p class="text-[#22c55e]">–ü–æ–±–µ–¥–∞! +${win.toFixed(2)}</p>`;
            } else {
                // –ü—Ä–æ–∏–≥—Ä—ã—à - –¥–µ–Ω—å–≥–∏ —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—ã
                gameData.losses++; 
                gameData.totalLost += minesState.bet;
                saveData(); updateUI();
                minesStatus.innerHTML = `<p class="text-[#ef4444]">–ë–∞–±–∞—Ö!</p>`;
                mineGrid.classList.add('shake');
                setTimeout(()=>mineGrid.classList.remove('shake'), 500);
            }
            
            minesStartBtn.disabled = false;
            minesCashoutBtn.disabled = true;
            minesBetInput.disabled = false;
            minesCountInput.disabled = false;
        }

        function cashoutMines() {
            if(!minesState.isPlaying || minesState.revealed === 0) return;
            endMines(true);
        }

        minesStartBtn.addEventListener('click', startMines);
        minesCashoutBtn.addEventListener('click', cashoutMines);

        // ================== TOWER GAME ==================
        const towerMults = { 1: 1.22, 2: 1.63, 3: 2.45, 4: 4.9 };
        let towerState = { isPlaying: false, bet: 0, level: 1, bombsCount: 1, field: [], mult: 1, gameOver: false };
        const towerGrid = document.getElementById('tower-grid');
        const towerBetInput = document.getElementById('tower-bet');
        const towerBombsInput = document.getElementById('tower-bombs');
        const towerMultDisplay = document.getElementById('tower-mult');
        const towerStatus = document.getElementById('tower-status');
        const towerStartBtn = document.getElementById('tower-start');
        const towerCashoutBtn = document.getElementById('tower-cashout');

        function buildTowerGrid() {
            towerGrid.innerHTML = '';
            for(let r=0; r<10; r++) {
                const row = document.createElement('div');
                row.className = 'tower-row';
                for(let c=0; c<5; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'tower-cell locked';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    row.appendChild(cell);
                }
                towerGrid.appendChild(row);
            }
        }

        function startTower() {
            const bet = parseFloat(towerBetInput.value);
            const bombs = parseInt(towerBombsInput.value);
            if(isNaN(bet) || bet < 1 || bet > gameData.balance) return showNotification('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞', 'error');
            if(isNaN(bombs) || bombs < 1 || bombs > 4) return showNotification('–ë–æ–º–±—ã: 1-4', 'error');

            gameData.balance -= bet;
            updateUI();
            syncBalance(-bet);

            const field = [];
            for(let i=0; i<10; i++) {
                const bp = [];
                while(bp.length < bombs) { const p = Math.floor(Math.random()*5); if(!bp.includes(p)) bp.push(p); }
                field.push(bp);
            }

            towerState = { isPlaying: true, bet, level: 1, bombsCount: bombs, field, mult: 1, gameOver: false };
            towerMultDisplay.textContent = '1.00x';
            towerStatus.innerHTML = `<p class="text-[#f0b429]">–£—Ä–æ–≤–µ–Ω—å 1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–µ—Ç–∫—É.</p>`;
            towerStartBtn.disabled = true;
            towerCashoutBtn.disabled = true;
            towerBetInput.disabled = true;
            towerBombsInput.disabled = false;

            buildTowerGrid();
            updateTowerUI();
            document.querySelectorAll('.tower-cell').forEach(c => c.addEventListener('click', handleTowerClick));
        }

        function updateTowerUI() {
            document.querySelectorAll('.tower-cell').forEach(cell => {
                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);
                const currentRow = towerState.level - 1;
                cell.classList.remove('active-row', 'revealed', 'gem', 'mine', 'locked');
                if (r < currentRow) {
                    cell.classList.add('revealed');
                    if (towerState.field[r].includes(c)) cell.classList.add('mine');
                    else cell.classList.add('gem');
                } else if (r === currentRow && !towerState.gameOver) cell.classList.add('active-row');
                else cell.classList.add('locked');
            });
        }

        function handleTowerClick(e) {
            if(!towerState.isPlaying || towerState.gameOver) return;
            const cell = e.target.closest('.tower-cell');
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            if(r !== towerState.level - 1) return;

            if(towerState.field[r].includes(c)) {
                cell.classList.add('revealed', 'mine');
                cell.innerHTML = 'üí•';
                endTower(false);
            } else {
                cell.classList.add('revealed', 'gem');
                cell.innerHTML = 'üíé';
                towerState.level++;
                towerState.mult *= towerMults[towerState.bombsCount];
                towerMultDisplay.textContent = towerState.mult.toFixed(2) + 'x';
                towerStatus.innerHTML = `<p class="text-[#22c55e]">–£—Å–ø–µ—Ö! –£—Ä–æ–≤–µ–Ω—å ${towerState.level}</p>`;
                towerCashoutBtn.disabled = false;
                if(towerState.level > 10) endTower(true);
                else updateTowerUI();
            }
        }

        function endTower(won) {
            towerState.gameOver = true; towerState.isPlaying = false;
            const r = towerState.level - 1;
            if(r < 10) {
                document.querySelectorAll(`.tower-cell[data-row="${r}"]`).forEach(c => {
                    const col = parseInt(c.dataset.col);
                    if(towerState.field[r].includes(col)) { c.classList.add('revealed', 'mine'); c.innerHTML = 'üí•'; }
                });
            }
            if(won) {
                const win = towerState.bet * towerState.mult;
                genericEndGame(true, win);
                towerStatus.innerHTML = `<p class="text-[#22c55e]">–ü–æ–±–µ–¥–∞! +${win.toFixed(2)}</p>`;
            } else {
                gameData.losses++; gameData.totalLost += towerState.bet;
                saveData(); updateUI();
                towerStatus.innerHTML = `<p class="text-[#ef4444]">–í–∑—Ä—ã–≤!</p>`;
            }
            towerStartBtn.disabled = false; towerCashoutBtn.disabled = true;
            towerBetInput.disabled = false; towerBombsInput.disabled = false;
        }

        function cashoutTower() {
            if(!towerState.isPlaying || towerState.level === 1) return;
            const win = towerState.bet * towerState.mult;
            towerState.gameOver = true; towerState.isPlaying = false;
            genericEndGame(true, win);
            towerStatus.innerHTML = `<p class="text-[#22c55e]">–ó–∞–±—Ä–∞–Ω–æ +${win.toFixed(2)}</p>`;
            towerStartBtn.disabled = false; towerCashoutBtn.disabled = true;
            towerBetInput.disabled = false; towerBombsInput.disabled = false;
        }

        towerStartBtn.addEventListener('click', startTower);
        towerCashoutBtn.addEventListener('click', cashoutTower);

        // ================== CRASH GAME ==================
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        const crashBetInput = document.getElementById('crash-bet');
        const crashAutoStop = document.getElementById('crash-auto-stop');
        const crashBetBtn = document.getElementById('crash-bet-btn');
        const crashWithdrawBtn = document.getElementById('crash-withdraw-btn');
        const crashStatusText = document.getElementById('crash-status-text');
        const crashMultDisplay = document.getElementById('crash-mult-display');
        const crashHistoryEl = document.getElementById('crash-history');

        let crashGameState = {
            isPlaying: false, hasBet: false, bet: 0, autoStop: 0,
            crashed: false, multiplier: 1.00, animationFrame: null,
            history: []
        };
        
        let crashStart = 0;
        let crashPoint = 1.00;

        function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function generateCrashPoint() {
            const e = Math.random(); 
            if (e < 0.01) return 1.00;
            return Math.max(1, (0.99 / (1 - e))); 
        }

        function getHistoryClass(mult) {
            if (mult < 2) return 'history-low';
            if (mult < 10) return 'history-mid';
            return 'history-high';
        }

        function addHistory(mult) {
            crashGameState.history.unshift(mult);
            if (crashGameState.history.length > 10) crashGameState.history.pop();
            renderHistory();
        }

        function renderHistory() {
            crashHistoryEl.innerHTML = crashGameState.history.map(m => 
                `<div class="history-item ${getHistoryClass(m)}">${m.toFixed(2)}x</div>`
            ).join('');
        }

        function startCrashLoop() {
            if(crashGameState.isPlaying) return;
            
            crashGameState.isPlaying = true;
            crashGameState.crashed = false;
            crashGameState.multiplier = 1.00;
            crashStart = Date.now();
            crashPoint = generateCrashPoint();
            
            crashStatusText.textContent = '–ü–æ–ª–µ—Ç–µ–ª–∏!';
            crashStatusText.className = 'crash-waiting-text text-white';
            crashMultDisplay.className = 'crash-multiplier-text';
            
            crashLoop();
        }

        function crashLoop() {
            if(!crashGameState.isPlaying) return;

            const elapsed = Date.now() - crashStart;
            crashGameState.multiplier = Math.exp(elapsed / 3000);

            crashMultDisplay.textContent = crashGameState.multiplier.toFixed(2) + 'x';

            if(crashGameState.hasBet && crashGameState.multiplier >= crashGameState.autoStop) {
                withdrawCrash();
            }

            if(crashGameState.multiplier >= crashPoint) {
                crash();
            } else {
                drawCrashGraph(elapsed);
                crashGameState.animationFrame = requestAnimationFrame(crashLoop);
            }
        }

        function drawCrashGraph(elapsed) {
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0, 0, w, h);
            
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for(let i=0; i<w; i+=50) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); }
            for(let i=0; i<h; i+=50) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); }

            const maxX = 10000; const maxY = 20;
            const progressX = Math.min(1, elapsed / maxX);
            const progressY = Math.min(1, (crashGameState.multiplier - 1) / (maxY - 1));
            
            const startX = 50;
            const startY = h - 50;
            const currentX = startX + (w - 100) * progressX;
            const currentY = startY - (h - 100) * progressY;

            ctx.strokeStyle = '#f0b429';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            
            const cpX = currentX * 0.5;
            const cpY = startY - (startY - currentY) * 0.8;
            ctx.quadraticCurveTo(cpX, cpY, currentX, currentY);
            ctx.stroke();

            drawRocket(currentX, currentY, progressX * 45);
        }

        function drawRocket(x, y, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-angle * Math.PI / 180);
            
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.moveTo(10, 0);
            ctx.lineTo(-5, -5);
            ctx.lineTo(-5, 5);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = '#f0b429';
            ctx.beginPath();
            ctx.moveTo(-5, 0);
            ctx.lineTo(-12, 0);
            ctx.lineTo(-5, 3);
            ctx.lineTo(-5, -3);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        function crash() {
            crashGameState.isPlaying = false;
            crashGameState.crashed = true;
            cancelAnimationFrame(crashGameState.animationFrame);

            crashMultDisplay.textContent = crashPoint.toFixed(2) + 'x';
            crashMultDisplay.className = 'crash-multiplier-text crashed';
            crashStatusText.textContent = '–ö–†–ê–•!';
            crashStatusText.className = 'crash-waiting-text text-[#ef4444]';

            addHistory(crashPoint);

            if(crashGameState.hasBet) {
                genericEndGame(false, crashGameState.bet);
                crashGameState.hasBet = false;
                crashBetBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
                crashBetBtn.disabled = false;
            }

            crashWithdrawBtn.disabled = true;
            
            setTimeout(() => {
                crashStatusText.textContent = '–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ —á–µ—Ä–µ–∑ 3—Å...';
                crashMultDisplay.textContent = '1.00x';
                crashMultDisplay.className = 'crash-multiplier-text';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                setTimeout(startCrashLoop, 3000);
            }, 2000);
        }

        function placeCrashBet() {
            if(crashGameState.isPlaying || crashGameState.hasBet) return;
            
            const bet = parseFloat(crashBetInput.value);
            const stop = parseFloat(crashAutoStop.value);

            if(isNaN(bet) || bet < 1 || bet > gameData.balance) return showNotification('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞', 'error');
            if(isNaN(stop) || stop < 1.01) return showNotification('–ê–≤—Ç–æ-—Å—Ç–æ–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 1.00', 'error');

            gameData.balance -= bet;
            updateUI();
            syncBalance(-bet);

            crashGameState.hasBet = true;
            crashGameState.bet = bet;
            crashGameState.autoStop = stop;

            crashBetBtn.disabled = true;
            crashBetBtn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            
            showNotification('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞', 'info');
        }

        function withdrawCrash() {
            if(!crashGameState.isPlaying || !crashGameState.hasBet) return;
            
            const win = crashGameState.bet * crashGameState.multiplier;
            genericEndGame(true, win - crashGameState.bet);
            
            crashGameState.hasBet = false;
            crashWithdrawBtn.disabled = true;
            crashBetBtn.disabled = false;
            crashBetBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
            
            crashMultDisplay.classList.add('cashed-out');
            setTimeout(() => crashMultDisplay.classList.remove('cashed-out'), 1000);
            
            showNotification(`–ó–∞–±—Ä–∞–Ω–æ ${win.toFixed(2)} –ø—Ä–∏ x${crashGameState.multiplier.toFixed(2)}`, 'success');
        }

        crashBetBtn.addEventListener('click', placeCrashBet);
        crashWithdrawBtn.addEventListener('click', withdrawCrash);

        setInterval(() => {
            if(crashGameState.isPlaying && crashGameState.hasBet) crashWithdrawBtn.disabled = false;
        }, 50);

        setTimeout(() => {
            crashStatusText.textContent = '–ò–≥—Ä–∞ —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è...';
            setTimeout(startCrashLoop, 2000);
        }, 500);


        // ================== NAVIGATION & INIT ==================
        navItems.forEach(item => item.addEventListener('click', () => switchSection(item.dataset.section)));
        saveNicknameBtn.addEventListener('click', () => {
            const n = nicknameInput.value.trim();
            if(n.length > 0) { 
                gameData.nickname = n; 
                saveData(); 
                syncBalance(0, n); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                updateUI(); 
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); 
            }
        });
        hourlyBonusBtn.addEventListener('click', claimHourly);
        dailyBonusBtn.addEventListener('click', claimDaily);
        
        document.querySelectorAll('.game-card[data-game]').forEach(card => {
            card.addEventListener('click', () => {
                const g = card.dataset.game;
                switchSection(g + '-game');
                if(g === 'tower' && !towerState.isPlaying) buildTowerGrid();
                if(g === 'mines' && !minesState.isPlaying) createMineGrid();
            });
        });

        function init() {
            loadData();
            updateUI();
            fetchBalance(); // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            updateBonusTimers();
            setInterval(updateBonusTimers, 1000);
        }

        init();
    </script>

